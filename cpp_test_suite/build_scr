#!/bin/bash

#INSTALL_DIR=/segfs/tango/tmp/ci
INSTALL_DIR=/tmp/ci
DS_NAME=devTest
DS_INST_NAME=api
DS_INST_NAME_2=api2

for i in $NODE_LABELS
do
	echo $i
	if [ $i = "ubuntu10.04" ]
	then
		echo "Ubuntu 10.04 OS"
		OS_SPEC="linux=1 ubuntu=1"
		BIN_DIR="ubuntu1004"
		MAKE_PATH="make"
	fi
	
	if [ $i = "solaris10" ]
	then
		echo "Solaris 10 OS"
		OS_SPEC="_solaris=1"
		BIN_DIR="solaris10_CC"
		MAKE_PATH="/usr/local/bin/make"
	fi
	
	if [ $i = "redhate5" ]
	then
		echo "redhate 5 OS"
		OS_SPEC="linux=1"
		BIN_DIR="redhate5"
		MAKE_PATH="make"
	fi
done

MAKE_CMD="$MAKE_PATH prefix=$INSTALL_DIR $OS_SPEC all"

cd cpp_test_suite
echo $MAKE_CMD
$MAKE_CMD
cd asyn
echo $MAKE_CMD
$MAKE_CMD
cd ../event
echo $MAKE_CMD
$MAKE_CMD
cd ..

#
# Now Start the first device server
#

TANGO_LIB=$INSTALL_DIR/$BIN_DIR/lib/debug
LOG4TANGO_LIB=/segfs/tango/tools/log4tango-release/log4tango4.0.3/$BIN_DIR/lib
ORB_LIB=/segfs/tango/ORB/omniORB4.1.4/$BIN_DIR/lib

export LD_LIBRARY_PATH=$TANGO_LIB:$LOG4TANGO_LIB:$ORB_LIB:$LD_LIBRARY_PATH
export TANGO_HOST=kidiboo:10000

$INSTALL_DIR/$BIN_DIR/bin/shared/$DS_NAME $DS_INST_NAME 1>/dev/null 2>&1 &
$INSTALL_DIR/$BIN_DIR/bin/shared/$DS_NAME $DS_INST_NAME_2 1>/dev/null 2>&1 &

#
# Wait before starting test
#

sleep 2
ps -ef | grep devTest

#
# Start test
#

./runtest jenkins $INSTALL_DIR
RET=$?
if [ $RET = "0" ]
then
	echo "Calling another test suite"
fi 

#
# kill the servers
#

PIDS=`ps -e | grep $DS_NAME | grep -v grep | awk '{print $1}'`
for pid in $PIDS
do
	echo "Killing process with PID $pid"
	kill $pid
done

exit $RET
